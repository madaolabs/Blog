<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    
 
    <title>Closure | Madaolabs</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <meta name="description" content="有些语言中没有 closure 和普通函数的区分，但 Rust 有。对 Rust 来说普通函数就是一段代码。而 closure 和 C++ 类似：每个 closure 会创建一个匿名的 struct，编译器会在当前上下文捕获 closure 代码中的外部变量然后塞进这个结构体里面。 为什么要有闭包？在 rust 中函数是不能捕获动态环境变量，这是因为在 Rust 中，函数是静态的，而不是动态的。函">
<meta property="og:type" content="article">
<meta property="og:title" content="Closure">
<meta property="og:url" content="https://blog.madaotech.top/2023/09/27/rust/closure/index.html">
<meta property="og:site_name" content="Madaolabs">
<meta property="og:description" content="有些语言中没有 closure 和普通函数的区分，但 Rust 有。对 Rust 来说普通函数就是一段代码。而 closure 和 C++ 类似：每个 closure 会创建一个匿名的 struct，编译器会在当前上下文捕获 closure 代码中的外部变量然后塞进这个结构体里面。 为什么要有闭包？在 rust 中函数是不能捕获动态环境变量，这是因为在 Rust 中，函数是静态的，而不是动态的。函">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-09-27T11:35:01.000Z">
<meta property="article:modified_time" content="2024-02-26T11:14:44.671Z">
<meta property="article:tag" content="rust">
<meta name="twitter:card" content="summary">  
    <link rel="icon" href="/favicon.ico" />
     
    <link
      href="//fonts.loli.net/css?family=Source+Code+Pro"
      rel="stylesheet"
      type="text/css"
    />
    
    <link
      href="https://fonts.loli.net/css?family=Noto+Sans+KR:100,300,400,700&amp;subset=korean"
      rel="stylesheet"
    />
    
<link rel="stylesheet" href="/css/style.css">

  <meta name="generator" content="Hexo 6.3.0"></head>
</html>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <!--<div id="banner"></div>-->
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"> </a>
        <a href="/" id="main-nav-title" class="main-nav-link">
          Madaolabs</a
        >
        
        <a class="main-nav-link" href="/archives/"
          >Archives</a
        >
        
      </nav>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-rust/closure" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Closure
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>有些语言中没有 closure 和普通函数的区分，但 Rust 有。对 Rust 来说普通函数就是一段代码。而 closure 和 C++ 类似：每个 closure 会创建一个匿名的 struct，编译器会在当前上下文捕获 closure 代码中的外部变量然后塞进这个<strong>结构体</strong>里面。</p>
<p>为什么要有闭包？<br>在 rust 中函数是不能捕获<strong>动态环境变量</strong>，这是因为在 Rust 中，函数是静态的，而不是动态的。函数定义时，所有的变量和参数都必须是已知的、固定的值。这意味着，函数不能从其所在的环境中捕获任何动态变量。而闭包可以。下面展示使用函数调用作用域变量的错误：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">equal_to_x</span>(z: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123; z == x &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert!</span>(<span class="title function_ invoke__">equal_to_x</span>(y));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 无法通过编译</span></span><br><span class="line"></span><br><span class="line">error[E0434]: can<span class="symbol">&#x27;t</span> capture dynamic environment <span class="keyword">in</span> a <span class="keyword">fn</span> <span class="title function_">item</span>; <span class="keyword">use</span> the || &#123; ...</span><br><span class="line">&#125; closure form instead</span><br><span class="line"> -<span class="punctuation">-&gt;</span> src/main.rs</span><br><span class="line">  |</span><br><span class="line"><span class="number">4</span> |     <span class="keyword">fn</span> <span class="title function_">equal_to_x</span>(z: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123; z == x &#125;</span><br><span class="line">  |</span><br></pre></td></tr></table></figure>

<p>闭包是可以捕获环境变量的，捕获的方式有 3 种<strong>Trait</strong>：FnOnce, FnMut, Fn</p>
<p>FnOnce 表示：捕获到的环境变量<strong>所有值转移</strong><br>FnMut 表示：捕获到的环境变量<strong>可变借用</strong><br>Fn 表示：捕获到的环境变量<strong>不可变借用</strong></p>
<p>上面所说的并不是绝对的，注意：<strong>一个闭包实现了哪种 Fn 特征取决于该闭包如何使用被捕获的变量，而不是取决于闭包如何捕获它们</strong>，入下面的代码：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">update_string</span> =  <span class="keyword">move</span> || <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>,s);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">exec</span>(update_string);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">exec</span>&lt;F: <span class="title function_ invoke__">FnOnce</span>()&gt;(f: F)  &#123;</span><br><span class="line">    <span class="title function_ invoke__">f</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>虽然声明了特征值：FnOnce，但是内部使用的是不可变借用，所以该闭包也实现了 Fn 特征。所以上面的代码: FnOnce 改为 Fn 也是可以的：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">update_string</span> =  <span class="keyword">move</span> || <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>,s);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">exec</span>(update_string);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">exec</span>&lt;F: <span class="title function_ invoke__">Fn</span>()&gt;(f: F)  &#123;</span><br><span class="line">    <span class="title function_ invoke__">f</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.madaotech.top/2023/09/27/rust/closure/" data-id="clt2udoxp000ik3q5a97edgf9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rust/" rel="tag">rust</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/09/27/rust/trait/" id="article-nav-newer" class="article-nav-link-wrap">
      <span class="article-nav-caption">Newer</span>
      <div class="article-nav-title">
        
          Trait
        
      </div>
    </a>
  
  
    <a href="/2023/09/26/knowledgeOfComputer/secp256k1/" id="article-nav-older" class="article-nav-link-wrap">
      <span class="article-nav-caption">Older</span>
      <div class="article-nav-title">以太坊中的secp256k1</div>
    </a>
  
</nav>

  
</article>

</section>
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024, Madaolabs<br />
      <!-- Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> with 
      theme_by <a href="http://hexo.io/" target="_blank">mango</a> -->
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/archives/" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.loli.net/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

 
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
 
<script src="/fancybox/jquery.fancybox.pack.js"></script>
  
<script src="/js/script.js"></script>
 


  </div>
</body>
</html>